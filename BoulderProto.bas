10 SCREEN 0
20 DIM FX(50):DIM FY(50):F=0
30 DIM WX(20):DIM WY(20):W=0
40 DIM M$(21)
50 L%=1
60 ON L% GOSUB 20000
70 GOSUB 10000:REM DRAW MAZE
80 TC=0
90 X=3:Y=2:SC=0
100 REM ===== GAME LOOP =====
110 J=JOY(1)
120 IF J=1 THEN GOTO 500
130 IF J=2 THEN GOTO 1000
140 IF J=4 THEN GOTO 1500
150 IF J=8 THEN GOTO 2000
160 FOR I=1 TO 100:NEXT I
165 TC=TC+1
170 IF INT(TC/2)=TC/2 THEN GOSUB 4000
180 GOTO 110
500 REM ===== MOVE RIGHT =====
510 VPOKE 0,Y*256+X*2,32
520 CX=X:CY=Y-1
530 NX=X+1:NY=Y:GOSUB 5000
540 IF C=0 THEN X=NX
550 IF C=0 AND VPEEK(0,CY*256+CX*2)=81 THEN GOSUB 3000
560 VPOKE 0,Y*256+X*2,42:VPOKE 0,Y*256+X*2+1,$01
570 GOTO 160
1000 REM ===== MOVE LEFT =====
1010 VPOKE 0,Y*256+X*2,32
1020 CX=X:CY=Y-1
1030 NX=X-1:NY=Y:GOSUB 5000
1040 IF C=0 THEN X=NX
1050 IF C=0 AND VPEEK(0,CY*256+CX*2)=81 THEN GOSUB 3000
1060 VPOKE 0,Y*256+X*2,42:VPOKE 0,Y*256+X*2+1,$01
1070 GOTO 160
1500 REM ===== MOVE DOWN =====
1510 VPOKE 0,Y*256+X*2,32
1520 CX=X:CY=Y-1
1530 NX=X:NY=Y+1:GOSUB 5000
1535 IF C=1 THEN GOTO 1560
1540 Y=NY
1550 IF VPEEK(0,CY*256+CX*2)=81 THEN GOSUB 3000
1560 VPOKE 0,Y*256+X*2,42:VPOKE 0,Y*256+X*2+1,$01
1570 GOTO 160
1650 VPOKE 0,CY*256+(CX+1)*2,32:VPOKE 0,CY*256+CX*2,81
1660 W=W+1:WX=CX:WY=CY
2000 REM ===== MOVE UP =====
2010 VPOKE 0,Y*256+X*2,32
2100 NX=X:NY=Y-1:GOSUB 5000
2110 IF C=0 THEN Y=NY
2120 VPOKE 0,Y*256+X*2,42:VPOKE 0,Y*256+X*2+1,$01
2130 GOTO 160
3000 REM ===== ADD BOULDER TO SORTED LIST =====
3010 F=F+1:FX(F)=0:FY(F)=0
3020 IF F=1 THEN FY(1)=CY:FX(1)=CX:RETURN
3030 I=F-1
3040 IF CY<FY(I) THEN FY(I+1)=CY:FX(I+1)=CX:RETURN
3050 FY(I+1)=FY(I):FX(I+1)=FX(I)
3060 I=I-1:IF I=0 THEN FY(1)=CY:FX(1)=CX:RETURN
3070 GOTO 3040
3500 REM DEBUGGING
3510 PRINT "\X13DEBUGGING",F
3520 FOR I=1 TO F
3530 PRINT FX(I),FY(I)
3540 NEXT I
3550 RETURN
4000 REM ===== MOVE FALLING BOULDERS =====
4010 IF F=0 THEN RETURN
4020 FOR I=1 TO F
4030 TB=VPEEK(0,(FY(I)+1)*256+FX(I)*2)
4040 IF TB<>32 GOTO 4200
4060 VPOKE 0,FY(I)*256+FX(I)*2,32
4070 FY(I)=FY(I)+1
4080 VPOKE 0,FY(I)*256+FX(I)*2,87:VPOKE 0,FY(I)*256+FX(I)*2+1,$0C
4090 REM ===== IF THERE IS BOULDER ABOVE ADD TO WAIT LIST =====
4100 IF VPEEK(0,(FY(I)-2)*256+FX(I)*2)<>81 GOTO 4600
4110 W=W+1:WY(W)=FY(I)-2:WX(W)=FX(I)
4190 GOTO 4600
4200 REM CHECK CONDITIONS IF NOT SPACE
4210 IF TB=42 THEN GOSUB 6000
4220 IF TB=81 OR TB=90 THEN GOSUB 5500:GOTO 4600
4290 VPOKE 0,FY(I)*256+FX(I)*2,81:VPOKE 0,FY(I)*256+FX(I)*2+1,$0C
4300 REM ==== REMOVE FROM LIST =====
4310 FX(I)=0 :FY(I)=0
4600 NEXT I
4700 REM ===== REMOVE STATIONARY =====
4710 IF F=0 THEN GOTO 4780
4720 I=1:G=0
4730 IF FX(I+G)=0  THEN G=G+1:GOTO 4750
4740 FX(I)=FX(I+G):FY(I)=FY(I+G):I=I+1
4750 IF I+G<=F THEN GOTO 4730
4760 F=F-G
4770 REM ===== ADD BOULDERS FROM WAITLIST =====
4780 IF W=0 THEN RETURN
4790 FOR K=1 TO W
4800 CY=WY(K):CX=WX(K)
4810 GOSUB 3000
4820 NEXT K
4830 W=0
4840 RETURN
5000 REM ===== PLAYER COLLISION CONTROL =====
5010 A=VPEEK(0,NY*256+NX*2)
5020 IF A=166 THEN C=0:RETURN
5030 IF A=81 OR A=87 THEN C=1:RETURN
5040 IF A=35 OR A=113 THEN C=1:RETURN
5050 IF A=90 THEN GOSUB 5200
5060 IF A=0 THEN PRINT"CONGRATULATIONS YOU FINSIHED THE LEVEL":END
5090 C=0:RETURN
5100 RETURN
5200 REM ===== PICKED UP THE DIAMOND =====
5210 DC=DC+1:SC=SC+100
5220 IF DC=DR THEN VPOKE 0,EY*256+EX*2,CH(8):VPOKE 0,EY*256+EX*2+1,CO(8)
5230 IF DC>DR THEN SC=SC+50
5250 RETURN
5500 REM ===== BOULDER HIT ANOTHER BOULDER OR DIAMOND =====
5510 TL=VPEEK(0,FY(I)*256+(FX(I)-1)*2)
5515 LL=VPEEK(0,(FY(I)+1)*256+(FX(I)-1)*2)
5520 IF TL<>32 OR VPEEK(0,(FY(I)+1)*256+(FX(I)-1)*2)<>32 GOTO 5550
5525 VPOKE 0,FY(I)*256+FX(I)*2,32
5530 FX(I)=FX(I)-1
5535 VPOKE 0,FY(I)*256+FX(I)*2,87:VPOKE 0,FY(I)*256+FX(I)*2+1,$0C
5540 RETURN
5550 TR=VPEEK(0,FY(I)*256+(FX(I)+1)*2)
5555 LR=VPEEK(0,(FY(I)+1)*256+(FX(I)+1)*2)
5560 IF TR<>32 OR LR<>32 THEN VPOKE 0,FY(I)*256+FX(I)*2,81:FX(I)=0:RETURN
5565 VPOKE 0,FY(I)*256+FX(I)*2,32
5570 FX(I)=FX(I)+1
5575 VPOKE 0,FY(I)*256+FX(I)*2,87:VPOKE 0,FY(I)*256+FX(I)*2+1,$0C
5580 RETURN
6000 REM ===== PLAYER DEAD =====
6010 PRINT CHR$($13)+"DEAD"
6015 FOR Q=1TO10:GETA$:NEXT
6020 GET A$:IF A$="" GOTO 6020
6030 PRINT CHR$($13)+"    "
6040 RETURN
10000 REM ===== DRAW MAZE =====
10010 FOR Y=0 TO 21
10020 FOR X=0 TO 39
10030 A=VAL(MID$(M$(Y),X+1,1))
10040 VPOKE 0,Y*256+X*2,CH(A)
10050 VPOKE 0,Y*256+X*2+1,CO(A)
10060 NEXT X
10070 NEXT Y
10080 RETURN
20000 REM ===== ROOM 1 =====
20010 M$(0) ="2222222222222222222222222222222222222222"
20020 M$(1) ="2111111111111111111111111111111111111112"
20030 M$(2) ="21171111111311       33          3     2"
20040 M$(3) ="21111111111311      333          1     2"
20050 M$(4) ="21111111111311      333          1     2"
20060 M$(5) ="21111111111311      111          1     2"
20070 M$(6) ="2                                      2"
20080 M$(7) ="255555555555555555           55111311312"
20090 M$(8) ="21 11131141 113131         413 111111312"
20100 M$(9) ="211411111311111 111        3114111131112"
20110 M$(10)="2111311313111111111       13113111111112"
20120 M$(11)="21 1111131111111133       13113141111 12"
20130 M$(12)="21311 1131  1111131        1311131141312"
20140 M$(13)="2143111111111111113        1111141111132"
20150 M$(14)="2111111115555555555555555555555555555552"
20160 M$(15)="2  111111111 111411113111113111311111112"
20170 M$(16)="23 11111111133113111111113111111313 1162"
20180 M$(17)="2131131111111131111131  1111411131331112"
20190 M$(18)="211113411 111111113111111313411111131112"
20200 M$(19)="2111 11 13113133111111111313411111131132"
20210 M$(20)="2141111311111 111111111 1311311113111312"
20220 M$(21)="2222222222222222222222222222222222222222"
20230 CH(0)=32:CH(1)=102:CH(2)=35:CH(3)=81:CH(4)=90:CH(5)=113:CH(6)=91:CH(7)=42
20231 CH(8)=0
20240 CO(0)=$01:CO(1)=$02:CO(2)=$DD:CO(3)=$0C:CO(4)=$0E:CO(5)=$23:CO(6)=$D0
20241 CO(7)=$01:CO(8)=$70
20250 DA=13:DR=10:DC=0
20260 EX=38:EY=16
20270 RETURN
